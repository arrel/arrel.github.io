<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Arrel Gray</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=yes"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Lato:400,700"
      rel="stylesheet"
      type="text/css"
    />
    <style>
      :root {
        --box-size: 50px;
        --line-height: 50px;
      }
      * {
        margin: 0;
        padding: 0;
        font-size: 100%;
      }
      body {
        line-height: 1;
        font-family: "Lato", sans-serif;
        color: #333;
        background-color: #fcfcfc;
        font-size: 16px;
        overflow-y: scroll;
      }
      #content-container {
        position: fixed;
        top: 0;
        left: 0;
      }
      p,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        border-color: #eee;
        display: block;
        float: left;
        padding: 0;
        margin: 0;
        width: var(--box-size);
        line-height: var(--line-height);
        text-align: center;
        border-width: 1px;
        border-style: dashed;
        text-transform: uppercase;
        border-bottom: none;
        border-left: none;
      }
      p {
        color: #666;
        background: #fff;
        font-weight: bold;
      }
      p.name {
        color: #03738e;
        background: #fff;
        border-color: rgba(3, 115, 142, 0.5);
      }
      p.name.first-char {
        border-left: 1px dashed rgba(3, 115, 142, 0.5);
      }
      p.name.last-row {
        border-bottom: 1px dashed rgba(3, 115, 142, 0.5);
        margin-bottom: -1px;
      }
      .below-name {
        border-top: 1px dashed #eee;
      }
      h1 {
        color: #03738e;
      }
      h2 {
        color: #f1b703;
      }
      h3 {
        color: #f58602;
      }
      h4 {
        color: #f15b07;
      }
      h5 {
        color: #d92d01;
      }
      h6 {
        color: #999;
      }
    </style>
  </head>
  <body>
    <div id="content-container"></div>
    <div id="scroll-spacer"></div>
    <script type="text/javascript">
      (function () {
        var chars = 0;
        var cols, rows, boxSize;
        var wikiContent = ""; // Store the full Wikipedia content
        var scrollOffset = 0; // Number of rows to offset
        const pixelsPerRow = 100; // Scroll X pixels to move content up by one row

        const calculateLayout = function () {
          // Calculate optimal box size that divides evenly into viewport
          const minBoxSize = 30;
          const maxBoxSize = 80;
          const borderSize = 1;

          // Start with a reasonable number of columns (around 20-30)
          let targetCols = 25;
          boxSize = Math.floor(window.innerWidth / targetCols) - borderSize;

          // Clamp box size to reasonable range
          if (boxSize < minBoxSize) {
            boxSize = minBoxSize;
          } else if (boxSize > maxBoxSize) {
            boxSize = maxBoxSize;
          }

          // Recalculate actual columns and rows based on final box size
          cols = Math.floor(window.innerWidth / (boxSize + borderSize));
          rows = Math.ceil(window.innerHeight / (boxSize + borderSize));
          if (rows < 12) rows = 12;

          // Update CSS custom properties
          document.documentElement.style.setProperty(
            "--box-size",
            boxSize + "px"
          );
          document.documentElement.style.setProperty(
            "--line-height",
            boxSize + "px"
          );
        };

        calculateLayout();

        // Fixed positions for personal info (in character positions)
        const namePositions = {
          row5: cols * 5, // "Arrel Gray"
          row6: cols * 6, // " Product &"
          row7: cols * 7, // "Engineering"
        };

        var messages = {};
        messages[namePositions.row5] = { m: "Arrel Gray", c: "name" };
        messages[namePositions.row6] = { m: " Product &", c: "name" };
        messages[namePositions.row7] = { m: "Engineering", c: "name" };

        const stripTag = function (str, tag) {
          const html = document.createElement("div");
          html.innerHTML = str;
          let child = html.getElementsByTagName(tag);
          if (child.length > 0) child[0].remove();
          return html.innerHTML;
        };

        const isNamePosition = function (pos) {
          return (
            pos === namePositions.row5 ||
            pos === namePositions.row6 ||
            pos === namePositions.row7
          );
        };

        const cleanWikiContent = function (str) {
          // Remove entire <style>...</style> blocks first (including content)
          str = str.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, "");

          // Remove other unwanted tags
          str = stripTag(str, "table");

          // Remove all remaining HTML tags
          str = str.replace(/<[^>]*>/g, "");

          // Remove any leftover CSS that might have leaked (like .mw-parser-output{...})
          str = str.replace(/\.[a-z-]+[^{]*\{[^}]*\}/gi, "");

          // Remove section headers that are Wikipedia meta-content
          str = str.replace(/References\[edit\]/gi, "");
          str = str.replace(/External links\[edit\]/gi, "");
          str = str.replace(/See also\[edit\]/gi, "");
          str = str.replace(/Further reading\[edit\]/gi, "");
          str = str.replace(/Notes\[edit\]/gi, "");
          str = str.replace(/Bibliography\[edit\]/gi, "");

          // Remove [edit] links
          str = str.replace(/\[edit\]/gi, "");

          // Remove all bracketed references: [1], [2], [123], [a], [b], etc.
          str = str.replace(/\[[0-9a-z]+\]/gi, "");

          // Remove citation markers
          str = str.replace(/\[citation needed\]/gi, "");
          str = str.replace(/\[clarification needed\]/gi, "");
          str = str.replace(/\[when\?\]/gi, "");
          str = str.replace(/\[by whom\?\]/gi, "");

          // Remove pronunciation guides with IPA characters
          str = str.replace(/\/[ˈˌ][^\/]*\//g, "");
          str = str.replace(/\([^)]*[ˈˌ][^)]*\)/g, "");

          // Remove "vte" (view/talk/edit) markers
          str = str.replace(/\bvte\b/gi, "");

          // Remove Authority control databases and similar metadata blocks
          str = str.replace(/Authority control databases[^.]*\./gi, "");

          // Clean up special characters and normalize spaces
          str = str.replace(/&nbsp;/gi, " ");
          str = str.replace(/&amp;/gi, "&");
          str = str.replace(/&lt;/gi, "<");
          str = str.replace(/&gt;/gi, ">");
          str = str.replace(/&quot;/gi, '"');

          // Remove consecutive punctuation oddities
          str = str.replace(/\s+([.,;!?])/g, "$1");

          // Normalize whitespace
          str = str.replace(/\s+/g, " ");
          str = str.trim();

          return str;
        };

        const displayStr = function (str, offset = 0) {
          // Clean the Wikipedia content
          str = cleanWikiContent(str);
          // Convert to array of characters with spaces preserved
          var cleanStr = str;
          // Now render with offset
          chars = 0;
          var html = "";
          var contentIndex = offset * cols; // Start reading from this position in content
          var msg;

          for (var screenPos = 0; screenPos < rows * cols; screenPos++) {
            // Check if this is a name position (always show name here)
            if ((msg = messages[screenPos])) {
              // Add blank square before the name (left column)
              html += "<h1>&nbsp;</h1>";
              contentIndex++; // Skip content for the blank square

              var isLastRow = screenPos === namePositions.row7;
              var msgLength = msg.m.length;
              for (var j = 0; j < msgLength; j++) {
                var classes = msg.c || "";
                var char = msg.m.charAt(j);
                // Add first-char class to first character of each word
                // For "Arrel Gray" (row5): j === 0 ('A') and j === 6 ('G')
                // For " Product &" (row6): j === 1 ('P') and j === 9 ('&')
                // For "Engineering" (row7): j === 0 ('E')
                if (
                  j === 0 ||
                  (screenPos === namePositions.row5 && j === 6) ||
                  (screenPos === namePositions.row6 && (j === 1 || j === 9))
                ) {
                  classes += " first-char";
                }
                // Add last-row class to all characters in ENGINEERING
                if (isLastRow) {
                  classes += " last-row";
                }
                var c = classes ? ' class="' + classes.trim() + '"' : "";
                html += "<p" + c + ">" + char + "</p>";
                contentIndex++; // Skip content for each personal info character
              }
              // We rendered: 1 blank + msgLength characters
              // Skip ahead by that amount (the for loop will add 1 more)
              screenPos += msgLength; // This accounts for the message chars, the loop adds 1 for the blank
              msg = undefined;
              continue;
            }

            // Show content from Wikipedia, offset by scroll
            if (contentIndex < cleanStr.length) {
              var ch = cleanStr.charAt(contentIndex);

              // Check if it's a space - if in row 8 below name, skip spaces
              var isBelowName = screenPos >= cols * 8 && screenPos < cols * 9;
              if (isBelowName && ch == " ") {
                // Skip spaces in row 8 - advance content but don't render
                contentIndex++;
                screenPos--; // Decrement so loop increment keeps us at same position
                continue;
              }

              // Check if we need top border (row 8, non-space content)
              var belowClass = isBelowName ? ' class="below-name"' : '';

              // Check if it's a space
              if (ch == " ") {
                html += "<h1>&nbsp;</h1>";
              } else {
                var indx = 1 + Math.floor(Math.random() * 6);
                html += "<h" + indx + belowClass + ">" + ch + "</h" + indx + ">";
              }
              contentIndex++;
            } else {
              // No more content, show empty
              html += "<h1>&nbsp;</h1>";
            }
          }

          document.getElementById("content-container").innerHTML = html;

          // Set scroll spacer height to enable scrolling
          var totalContentRows = Math.ceil(cleanStr.length / cols) + 10;
          var spacerHeight = totalContentRows * pixelsPerRow;
          document.getElementById("scroll-spacer").style.height =
            spacerHeight + "px";
        };

        var folks = [
          "Robert_Noyce",
          "George_Westinghouse",
          "Bill_Hewlett",
          "Wright_brothers",
          "Alan_Kay",
        ];
        var folk = folks[Math.floor(Math.random() * folks.length)];
        window.makeItGo = function (data) {
          wikiContent = data.parse.text["*"];
          displayStr(wikiContent, scrollOffset);
        };
        var script = document.createElement("script");
        script.src =
          "https://en.wikipedia.org/w/api.php?action=parse&page=" +
          folk +
          "&format=json&prop=text&callback=makeItGo";
        document.body.appendChild(script);

        // Handle scroll events
        window.addEventListener("scroll", function () {
          var newOffset = Math.floor(window.scrollY / pixelsPerRow);
          if (newOffset !== scrollOffset && wikiContent) {
            scrollOffset = newOffset;
            displayStr(wikiContent, scrollOffset);
          }
        });

        // Recalculate and redraw on window resize
        let resizeTimeout;
        window.addEventListener("resize", function () {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(function () {
            scrollOffset = Math.floor(window.scrollY / pixelsPerRow);
            calculateLayout();

            // Recalculate name positions
            namePositions.row5 = cols * 5;
            namePositions.row6 = cols * 6;
            namePositions.row7 = cols * 7;

            messages = {};
            messages[namePositions.row5] = { m: "Arrel Gray", c: "name" };
            messages[namePositions.row6] = { m: " Product &", c: "name" };
            messages[namePositions.row7] = { m: "Engineering", c: "name" };

            if (wikiContent) {
              displayStr(wikiContent, scrollOffset);
            }
          }, 250);
        });
      })();
    </script>
  </body>
</html>
